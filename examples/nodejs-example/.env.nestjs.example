# ============================================
# NestJS Application Configuration
# ============================================

# Application Settings
NODE_ENV=production
PORT=3000

# ============================================
# OpenTelemetry Configuration (Recommended)
# ============================================

# Service Identification
OTEL_SERVICE_NAME=my-nestjs-app
OTEL_SERVICE_VERSION=1.0.0
OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production,service.namespace=backend,team=platform

# OTLP Exporter Endpoints
# For Docker/Kubernetes environments (gRPC - recommended for performance)
OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317
OTEL_EXPORTER_OTLP_PROTOCOL=grpc

# For local development (HTTP)
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4320
# OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf

# Signal-specific endpoints (optional - use if routing to different backends)
# OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://alloy:4317
# OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://alloy:4317
# OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=http://alloy:4317

# Enable All Observability Signals
OTEL_TRACES_EXPORTER=otlp
OTEL_METRICS_EXPORTER=otlp
OTEL_LOGS_EXPORTER=otlp

# ============================================
# Sampling Configuration
# ============================================

# Production: Use parentbased_traceidratio with 10-20% sampling
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.1

# Development: Sample everything
# OTEL_TRACES_SAMPLER=always_on
# OTEL_TRACES_SAMPLER_ARG=1.0

# High-traffic production: Lower sampling
# OTEL_TRACES_SAMPLER_ARG=0.05

# ============================================
# Batch Processing Configuration
# ============================================

# Span Batch Processor (recommended for production)
OTEL_BSP_MAX_QUEUE_SIZE=2048
OTEL_BSP_MAX_EXPORT_BATCH_SIZE=512
OTEL_BSP_SCHEDULE_DELAY=5000
OTEL_BSP_EXPORT_TIMEOUT=30000

# Metric Export Interval (milliseconds)
OTEL_METRIC_EXPORT_INTERVAL=60000
OTEL_METRIC_EXPORT_TIMEOUT=30000

# ============================================
# Context Propagation
# ============================================

# Propagators for Distributed Tracing
OTEL_PROPAGATORS=tracecontext,baggage

# If integrating with AWS X-Ray
# OTEL_PROPAGATORS=tracecontext,baggage,xray

# If integrating with Jaeger
# OTEL_PROPAGATORS=tracecontext,baggage,jaeger

# ============================================
# Instrumentation Control
# ============================================

# Log Level (debug, info, warn, error)
OTEL_LOG_LEVEL=info

# Development debug mode
# OTEL_LOG_LEVEL=debug

# Disable specific instrumentations if causing issues
# Common: fs (file system), dns (DNS lookups), net (network)
# OTEL_NODE_DISABLED_INSTRUMENTATIONS=fs,dns

# Enable only specific instrumentations (uncomment to use)
# OTEL_NODE_ENABLED_INSTRUMENTATIONS=http,express,nestjs-core,pg,redis

# ============================================
# NestJS-Specific Configuration
# ============================================

# NestJS instrumentation is included in auto-instrumentations-node
# It automatically captures:
# - HTTP requests/responses
# - Guards, Interceptors, Pipes
# - Exception filters
# - GraphQL operations (if using @nestjs/graphql)
# - Microservices (if using @nestjs/microservices)

# ============================================
# Pyroscope Profiling (Recommended)
# ============================================

# Enable continuous profiling for CPU and memory analysis
PYROSCOPE_SERVER_ADDRESS=http://alloy:4100
PYROSCOPE_APPLICATION_NAME=my-nestjs-app
PYROSCOPE_TAGS=environment=production,version=1.0.0
PYROSCOPE_AUTH_TOKEN=

# Profiling configuration
PYROSCOPE_SAMPLE_RATE=100
PYROSCOPE_UPLOAD_INTERVAL=10000

# Profile types to collect (all enabled by default)
# PYROSCOPE_PROFILE_CPU=true
# PYROSCOPE_PROFILE_HEAP=true

# ============================================
# Performance & Resource Limits
# ============================================

# Node.js Memory Settings (recommended for production)
# Max old space size (heap) - adjust based on your needs
# NODE_OPTIONS=--max-old-space-size=2048

# With OpenTelemetry auto-instrumentation
NODE_OPTIONS=--require @opentelemetry/auto-instrumentations-node/register --max-old-space-size=2048

# Enable source maps for better stack traces in profiling
# NODE_OPTIONS=--enable-source-maps --require @opentelemetry/auto-instrumentations-node/register

# ============================================
# Database & Redis Configuration
# ============================================

# PostgreSQL (automatically instrumented)
DATABASE_URL=postgresql://user:password@postgres:5432/mydb

# Redis (automatically instrumented)
REDIS_HOST=redis
REDIS_PORT=6379

# ============================================
# Health Check Filtering
# ============================================

# Health check endpoints are automatically filtered by Alloy
# If using custom health endpoints, they should follow these patterns:
# - /health, /healthz, /health/*, /readiness, /liveness
# These are ignored to reduce noise in traces

# ============================================
# Production Recommendations
# ============================================

# 1. Sampling: Start with 10% (0.1) and adjust based on traffic
# 2. Resource Attributes: Add meaningful tags (env, version, region, etc.)
# 3. Batch Settings: Use recommended values above
# 4. Memory: Set --max-old-space-size appropriate for your workload
# 5. Profiling: Enable for production to catch performance issues
# 6. Propagators: Include tracecontext and baggage minimum
# 7. Log Level: Use 'info' in production, 'debug' for troubleshooting
# 8. Disable FS instrumentation: Only if causing performance issues

# ============================================
# Development Settings
# ============================================

# For local development, override with:
# NODE_ENV=development
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4320
# OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
# OTEL_TRACES_SAMPLER=always_on
# OTEL_TRACES_SAMPLER_ARG=1.0
# OTEL_LOG_LEVEL=debug
# PYROSCOPE_SERVER_ADDRESS=http://localhost:4100

# ============================================
# Kubernetes/Docker Compose Deployment
# ============================================

# In Kubernetes, use service discovery:
# OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy.observability.svc.cluster.local:4317
# PYROSCOPE_SERVER_ADDRESS=http://alloy.observability.svc.cluster.local:4100

# In Docker Compose, use service names:
# OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317
# PYROSCOPE_SERVER_ADDRESS=http://alloy:4100

# ============================================
# Optional: Custom Attributes
# ============================================

# Add custom attributes to all spans/metrics
# OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production,service.version=1.0.0,cloud.provider=aws,cloud.region=us-east-1,k8s.cluster.name=prod-cluster,k8s.namespace.name=backend

# ============================================
# Security & Authentication
# ============================================

# If Alloy requires authentication
# OTEL_EXPORTER_OTLP_HEADERS=api-key=your-secret-key
# PYROSCOPE_AUTH_TOKEN=your-pyroscope-token

# For mTLS
# OTEL_EXPORTER_OTLP_CERTIFICATE=/path/to/cert.pem
# OTEL_EXPORTER_OTLP_CLIENT_KEY=/path/to/key.pem
# OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE=/path/to/client-cert.pem
